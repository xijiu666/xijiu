<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒæƒ…æ—¥è®° - è®°å½•æ¯æ—¥å¿ƒæƒ…</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            border-radius: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #5a67d8;
            font-size: 2.8rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #718096;
            font-size: 1.2rem;
            font-weight: 400;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .mood-selector {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }
        
        .mood-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .mood-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .mood-option:hover {
            transform: translateY(-5px);
        }
        
        .mood-option.selected {
            border-color: #5a67d8;
            background-color: rgba(90, 103, 216, 0.05);
        }
        
        .mood-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .mood-text {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .happy {
            color: #f6ad55;
        }
        
        .calm {
            color: #68d391;
        }
        
        .sad {
            color: #4fd1c5;
        }
        
        .anxious {
            color: #fc8181;
        }
        
        .diary-history {
            flex: 2;
            min-width: 300px;
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            color: #4a5568;
            font-size: 1.5rem;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #edf2f7;
        }
        
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            background-color: #f7fafc;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .history-item:hover {
            background-color: #edf2f7;
            transform: translateX(5px);
        }
        
        .history-date {
            font-weight: 600;
            min-width: 100px;
            color: #4a5568;
        }
        
        .history-mood {
            font-size: 1.8rem;
            margin: 0 20px;
        }
        
        .history-note {
            color: #718096;
            flex-grow: 1;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
        }
        
        .history-edit-btn, .history-delete-btn {
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.2s;
        }
        
        .history-edit-btn {
            color: #5a67d8;
        }
        
        .history-edit-btn:hover {
            background-color: rgba(90, 103, 216, 0.1);
        }
        
        .history-delete-btn {
            color: #fc8181;
        }
        
        .history-delete-btn:hover {
            background-color: rgba(252, 129, 129, 0.1);
        }
        
        .empty-history {
            text-align: center;
            color: #a0aec0;
            padding: 40px 20px;
            font-size: 1.1rem;
        }
        
        .note-input {
            margin-top: 30px;
        }
        
        textarea {
            width: 100%;
            height: 120px;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #5a67d8;
        }
        
        .date-selector {
            margin-bottom: 20px;
        }
        
        .date-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .date-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .date-input:focus {
            outline: none;
            border-color: #5a67d8;
        }
        
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }
        
        button {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .save-btn {
            background-color: #5a67d8;
            color: white;
            flex-grow: 1;
            margin-right: 15px;
        }
        
        .save-btn:hover {
            background-color: #4c51bf;
        }
        
        .clear-btn {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        
        .clear-btn:hover {
            background-color: #cbd5e0;
        }
        
        .add-past-btn {
            background-color: #68d391;
            color: white;
            margin-top: 15px;
            width: 100%;
        }
        
        .add-past-btn:hover {
            background-color: #48bb78;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: popIn 0.4s ease-out;
        }
        
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .modal-title {
            color: #5a67d8;
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        
        .modal-message {
            font-size: 1.2rem;
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .modal-close {
            background-color: #5a67d8;
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
        }
        
        .modal-close:hover {
            background-color: #4c51bf;
        }
        
        .comfort-message {
            background-color: #fff5f5;
            border-left: 5px solid #fc8181;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: left;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            flex: 1;
            min-width: 150px;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #5a67d8;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #718096;
            font-size: 1rem;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: #718096;
            font-size: 0.9rem;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .mood-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .save-btn {
                margin-right: 0;
                margin-bottom: 15px;
            }
            
            .history-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-heart"></i> å¿ƒæƒ…æ—¥è®°</h1>
            <p class="subtitle">è®°å½•æ¯æ—¥å¿ƒæƒ…ï¼Œå…³çˆ±å¿ƒç†å¥åº·</p>
        </header>
        
        <div class="main-content">
            <div class="mood-selector">
                <h2 class="section-title">è®°å½•å¿ƒæƒ…</h2>
                
                <div class="date-selector">
                    <label for="datePicker" class="date-label">é€‰æ‹©æ—¥æœŸï¼š</label>
                    <input type="date" id="datePicker" class="date-input" max="">
                </div>
                
                <p style="color: #718096; margin-bottom: 10px;">é€‰æ‹©æœ€ç¬¦åˆæ‚¨å¿ƒæƒ…çš„è¡¨æƒ…</p>
                
                <div class="mood-options">
                    <div class="mood-option" data-mood="å¼€å¿ƒ">
                        <div class="mood-icon happy">
                            <i class="far fa-smile-beam"></i>
                        </div>
                        <div class="mood-text happy">å¼€å¿ƒ</div>
                    </div>
                    
                    <div class="mood-option" data-mood="å¹³é™">
                        <div class="mood-icon calm">
                            <i class="far fa-smile"></i>
                        </div>
                        <div class="mood-text calm">å¹³é™</div>
                    </div>
                    
                    <div class="mood-option" data-mood="éš¾è¿‡">
                        <div class="mood-icon sad">
                            <i class="far fa-sad-tear"></i>
                        </div>
                        <div class="mood-text sad">éš¾è¿‡</div>
                    </div>
                    
                    <div class="mood-option" data-mood="çƒ¦èº">
                        <div class="mood-icon anxious">
                            <i class="far fa-tired"></i>
                        </div>
                        <div class="mood-text anxious">çƒ¦èº</div>
                    </div>
                </div>
                
                <div class="note-input">
                    <label for="note" style="display: block; margin-bottom: 10px; font-weight: 600; color: #4a5568;">æ·»åŠ å¤‡æ³¨ (å¯é€‰)</label>
                    <textarea id="note" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿæƒ³è®°å½•äº›ä»€ä¹ˆï¼Ÿ"></textarea>
                </div>
                
                <div class="buttons">
                    <button class="save-btn" id="saveBtn">
                        <i class="fas fa-save"></i> ä¿å­˜å¿ƒæƒ…è®°å½•
                    </button>
                    <button class="clear-btn" id="clearBtn">
                        <i class="fas fa-eraser"></i> æ¸…ç©ºè®°å½•
                    </button>
                </div>
                
                <button class="add-past-btn" id="addPastBtn">
                    <i class="fas fa-calendar-plus"></i> è¡¥å……ä¹‹å‰æ—¥æœŸçš„å¿ƒæƒ…
                </button>
            </div>
            
            <div class="diary-history">
                <h2 class="section-title">å¿ƒæƒ…è®°å½•å†å²</h2>
                
                <div class="history-list" id="historyList">
                    <!-- å†å²è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    <div class="empty-history">
                        <i class="far fa-calendar-check fa-3x" style="margin-bottom: 15px; color: #cbd5e0;"></i>
                        <p>è¿˜æ²¡æœ‰ä»»ä½•å¿ƒæƒ…è®°å½•</p>
                        <p style="margin-top: 5px; font-size: 0.9rem;">é€‰æ‹©ä¸Šæ–¹çš„å¿ƒæƒ…å¼€å§‹è®°å½•å§ï¼</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalDays">0</div>
                <div class="stat-label">è®°å½•æ€»å¤©æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="positiveDays">0</div>
                <div class="stat-label">ç§¯æå¿ƒæƒ…å¤©æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="negativeDays">0</div>
                <div class="stat-label">æ¶ˆæå¿ƒæƒ…å¤©æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="currentStreak">0</div>
                <div class="stat-label">æœ€é•¿è¿ç»­è®°å½•</div>
            </div>
        </div>
        
        <!-- å¿ƒæƒ…é€‰æ‹©å¼¹çª— -->
        <div class="modal" id="moodModal">
            <div class="modal-content">
                <h2 class="modal-title">æ‚¨å¥½ï¼è¯·è®°å½•ä»Šå¤©çš„å¿ƒæƒ…</h2>
                <p class="modal-message">ä»ä»¥ä¸‹é€‰é¡¹ä¸­é€‰æ‹©æœ€ç¬¦åˆæ‚¨ä»Šå¤©å¿ƒæƒ…çš„ä¸€é¡¹ï¼š</p>
                
                <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                    <button class="mood-btn" data-mood="å¼€å¿ƒ" style="background-color: #f6ad55;">
                        <i class="far fa-smile-beam"></i> å¼€å¿ƒ
                    </button>
                    <button class="mood-btn" data-mood="å¹³é™" style="background-color: #68d391;">
                        <i class="far fa-smile"></i> å¹³é™
                    </button>
                    <button class="mood-btn" data-mood="éš¾è¿‡" style="background-color: #4fd1c5;">
                        <i class="far fa-sad-tear"></i> éš¾è¿‡
                    </button>
                    <button class="mood-btn" data-mood="çƒ¦èº" style="background-color: #fc8181;">
                        <i class="far fa-tired"></i> çƒ¦èº
                    </button>
                </div>
            </div>
        </div>
        
        <!-- å®‰æ…°è¯­å¥å¼¹çª— -->
        <div class="modal" id="comfortModal">
            <div class="modal-content">
                <h2 class="modal-title">å…³å¿ƒæ‚¨çš„å¿ƒç†å¥åº·</h2>
                <p class="modal-message" id="comfortMessage"></p>
                
                <div class="comfort-message">
                    <p><strong>æ¸©é¦¨æç¤ºï¼š</strong>å¦‚æœæ‚¨è¿ç»­å¤šå¤©æ„Ÿåˆ°éš¾è¿‡æˆ–çƒ¦èºï¼Œå»ºè®®æ‚¨å¯ä»¥ï¼š</p>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li>ä¸äº²å‹èŠèŠå¤©ï¼Œåˆ†äº«æ‚¨çš„æ„Ÿå—</li>
                        <li>è¿›è¡Œä¸€äº›è½»æ¾çš„æ´»åŠ¨ï¼Œå¦‚æ•£æ­¥ã€å¬éŸ³ä¹</li>
                        <li>å°è¯•æ·±å‘¼å¸æˆ–å†¥æƒ³æ”¾æ¾</li>
                        <li>å¦‚æœæƒ…ç»ªæŒç»­ä½è½ï¼Œè€ƒè™‘å¯»æ±‚ä¸“ä¸šå¸®åŠ©</li>
                    </ul>
                </div>
                
                <button class="modal-close" id="closeComfortBtn" style="margin-top: 25px;">è°¢è°¢å…³å¿ƒï¼Œæˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
        
        <footer>
            <p>å¿ƒæƒ…æ—¥è®° &copy; 2023 | è®°å½•å¿ƒæƒ…ï¼Œå…³çˆ±è‡ªå·±</p>
            <p style="margin-top: 5px; font-size: 0.8rem;">æç¤ºï¼šæ•°æ®ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°ï¼Œæ¸…ç©ºæµè§ˆå™¨æ•°æ®ä¼šåˆ é™¤æ‰€æœ‰è®°å½•</p>
        </footer>
    </div>

    <script>
        // åˆå§‹åŒ–æ•°æ®
        let moodHistory = JSON.parse(localStorage.getItem('moodHistory')) || [];
        let selectedMood = null;
        let isEditing = false;
        let editingDate = null;
        
        // å®‰æ…°è¯­å¥åº“
        const comfortMessages = [
            "æœ€è¿‘æ‚¨ä¼¼ä¹æœ‰äº›æƒ…ç»ªä½è½ï¼Œè¦çŸ¥é“æ¯ä¸ªäººéƒ½æœ‰ä½è°·æœŸï¼Œè¿™å®Œå…¨æ­£å¸¸ã€‚è¯·è®°å¾—å–„å¾…è‡ªå·±ï¼Œç»™è‡ªå·±ä¸€äº›æ—¶é—´å’Œç©ºé—´ã€‚",
            "æƒ…ç»ªå°±åƒå¤©æ°”ï¼Œæœ‰æ—¶æ™´æœ—æœ‰æ—¶é˜´é›¨ã€‚é˜´é›¨è¿‡åæ€»ä¼šè¿æ¥é˜³å…‰ï¼Œè¯·ç›¸ä¿¡è¿™æ®µæ—¶é—´ä¹Ÿä¼šè¿‡å»ã€‚",
            "çœ‹åˆ°æ‚¨æœ€è¿‘å¿ƒæƒ…ä¸å¤ªå¥½ï¼Œæƒ³å‘Šè¯‰æ‚¨ï¼šæ‚¨çš„æ„Ÿå—æ˜¯é‡è¦çš„ï¼Œä¹Ÿæ˜¯æœ‰æ•ˆçš„ã€‚è¯·å…è®¸è‡ªå·±æ„Ÿå—è¿™äº›æƒ…ç»ªï¼Œå®ƒä»¬ä¼šæ…¢æ…¢è¿‡å»çš„ã€‚",
            "ç”Ÿæ´»æœ‰æ—¶ä¼šè®©äººæ„Ÿåˆ°ç–²æƒ«å’Œçƒ¦èºï¼Œè¿™æ˜¯äººä¹‹å¸¸æƒ…ã€‚è¯·è®°å¾—ï¼Œæ‚¨ä¸æ˜¯ä¸€ä¸ªäººï¼Œå¾ˆå¤šäººéƒ½å…³å¿ƒç€æ‚¨ã€‚",
            "æƒ…ç»ªä½è½æ—¶ï¼Œè¯·å°è¯•å¯¹è‡ªå·±æ¸©æŸ”ä¸€äº›ã€‚åšä¸€äº›è®©è‡ªå·±æ„Ÿåˆ°èˆ’é€‚çš„å°äº‹ï¼Œå“ªæ€•åªæ˜¯å–æ¯çƒ­èŒ¶ã€çœ‹çœ‹çª—å¤–çš„é£æ™¯ã€‚",
            "æœ€è¿‘æ‚¨ä¼¼ä¹ç»å†äº†ä¸€äº›è‰°éš¾çš„æ—¶åˆ»ï¼Œè¯·ç›¸ä¿¡æ‚¨çš„å†…åœ¨åŠ›é‡ï¼Œæ‚¨å·²ç»å…‹æœäº†å¾ˆå¤šå›°éš¾ï¼Œè¿™æ¬¡ä¹Ÿä¸€æ ·å¯ä»¥ã€‚"
        ];
        
        // DOMå…ƒç´ 
        const moodOptions = document.querySelectorAll('.mood-option');
        const saveBtn = document.getElementById('saveBtn');
        const clearBtn = document.getElementById('clearBtn');
        const addPastBtn = document.getElementById('addPastBtn');
        const historyList = document.getElementById('historyList');
        const moodModal = document.getElementById('moodModal');
        const comfortModal = document.getElementById('comfortModal');
        const comfortMessage = document.getElementById('comfortMessage');
        const closeComfortBtn = document.getElementById('closeComfortBtn');
        const moodModalButtons = document.querySelectorAll('.mood-btn');
        const datePicker = document.getElementById('datePicker');
        
        // ç»Ÿè®¡å…ƒç´ 
        const totalDaysEl = document.getElementById('totalDays');
        const positiveDaysEl = document.getElementById('positiveDays');
        const negativeDaysEl = document.getElementById('negativeDays');
        const currentStreakEl = document.getElementById('currentStreak');
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨çš„æœ€å¤§å€¼ä¸ºä»Šå¤©
            const today = getTodayDate();
            datePicker.max = today;
            datePicker.value = today;
            
            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²è®°å½•
            const todayRecord = moodHistory.find(record => record.date === today);
            
            // å¦‚æœä»Šå¤©è¿˜æ²¡æœ‰è®°å½•å¿ƒæƒ…ï¼Œæ˜¾ç¤ºå¼¹çª—
            if (!todayRecord) {
                setTimeout(() => {
                    moodModal.style.display = 'flex';
                }, 500);
            } else {
                // å¦‚æœä»Šå¤©å·²è®°å½•ï¼ŒåŠ è½½ä»Šå¤©çš„è®°å½•
                loadRecordByDate(today);
            }
            
            // åŠ è½½å†å²è®°å½•
            loadHistory();
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStats();
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå®‰æ…°å¼¹çª—
            checkForComfortMessage();
        });
        
        // é€‰æ‹©å¿ƒæƒ…
        moodOptions.forEach(option => {
            option.addEventListener('click', function() {
                // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
                moodOptions.forEach(opt => opt.classList.remove('selected'));
                
                // æ·»åŠ å½“å‰é€‰æ‹©
                this.classList.add('selected');
                selectedMood = this.getAttribute('data-mood');
            });
        });
        
        // æ—¥æœŸé€‰æ‹©å™¨å˜åŒ–æ—¶
        datePicker.addEventListener('change', function() {
            const selectedDate = this.value;
            loadRecordByDate(selectedDate);
        });
        
        // è¡¥å……ä¹‹å‰æ—¥æœŸæŒ‰é’®
        addPastBtn.addEventListener('click', function() {
            // éšæœºé€‰æ‹©ä¸€ä¸ªè¿‡å»7å¤©å†…çš„æ—¥æœŸ
            const today = new Date();
            const randomPastDate = new Date();
            randomPastDate.setDate(today.getDate() - Math.floor(Math.random() * 7) - 1);
            
            const formattedDate = formatDateForInput(randomPastDate);
            datePicker.value = formattedDate;
            
            // åŠ è½½è¯¥æ—¥æœŸçš„è®°å½•ï¼ˆå¦‚æœæœ‰ï¼‰
            loadRecordByDate(formattedDate);
            
            // æç¤ºç”¨æˆ·
            alert(`å·²åˆ‡æ¢åˆ° ${formatDisplayDate(formattedDate)}ï¼Œæ‚¨å¯ä»¥è®°å½•æˆ–ä¿®æ”¹è¯¥æ—¥çš„å¿ƒæƒ…ã€‚`);
        });
        
        // å¼¹çª—å¿ƒæƒ…é€‰æ‹©
        moodModalButtons.forEach(button => {
            button.addEventListener('click', function() {
                selectedMood = this.getAttribute('data-mood');
                
                // æ›´æ–°ä¸»ç•Œé¢ä¸Šçš„é€‰æ‹©
                moodOptions.forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.getAttribute('data-mood') === selectedMood) {
                        opt.classList.add('selected');
                    }
                });
                
                // å…³é—­å¼¹çª—
                moodModal.style.display = 'none';
                
                // è‡ªåŠ¨èšç„¦åˆ°å¤‡æ³¨æ¡†
                document.getElementById('note').focus();
            });
        });
        
        // ä¿å­˜å¿ƒæƒ…è®°å½•
        saveBtn.addEventListener('click', function() {
            const selectedDate = datePicker.value;
            const note = document.getElementById('note').value;
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å¿ƒæƒ…
            if (!selectedMood) {
                alert('è¯·å…ˆé€‰æ‹©å¿ƒæƒ…ï¼');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æ—¥æœŸ
            if (!selectedDate) {
                alert('è¯·é€‰æ‹©æ—¥æœŸï¼');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æœªæ¥æ—¥æœŸ
            const today = getTodayDate();
            if (selectedDate > today) {
                alert('ä¸èƒ½è®°å½•æœªæ¥æ—¥æœŸçš„å¿ƒæƒ…ï¼');
                return;
            }
            
            // æŸ¥æ‰¾è¯¥æ—¥æœŸæ˜¯å¦å·²æœ‰è®°å½•
            const existingRecordIndex = moodHistory.findIndex(record => record.date === selectedDate);
            
            if (existingRecordIndex !== -1) {
                // æ›´æ–°ç°æœ‰è®°å½•
                moodHistory[existingRecordIndex].mood = selectedMood;
                moodHistory[existingRecordIndex].note = note;
                
                // æŒ‰æ—¥æœŸæ’åºï¼Œç¡®ä¿æœ€æ–°è®°å½•åœ¨å‰é¢
                moodHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                alert('å¿ƒæƒ…è®°å½•å·²æ›´æ–°ï¼');
            } else {
                // æ·»åŠ æ–°è®°å½•
                moodHistory.unshift({
                    date: selectedDate,
                    mood: selectedMood,
                    note: note
                });
                
                alert('å¿ƒæƒ…è®°å½•å·²ä¿å­˜ï¼');
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('moodHistory', JSON.stringify(moodHistory));
            
            // é‡æ–°åŠ è½½å†å²è®°å½•
            loadHistory();
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStats();
            
            // å¦‚æœæ˜¯ç¼–è¾‘çŠ¶æ€ï¼Œé‡ç½®
            if (isEditing) {
                isEditing = false;
                editingDate = null;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜å¿ƒæƒ…è®°å½•';
            }
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå®‰æ…°å¼¹çª—
            checkForComfortMessage();
        });
        
        // æ¸…ç©ºè®°å½•
        clearBtn.addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¿ƒæƒ…è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                moodHistory = [];
                localStorage.removeItem('moodHistory');
                loadHistory();
                updateStats();
                resetForm();
                alert('æ‰€æœ‰è®°å½•å·²æ¸…ç©ºï¼');
            }
        });
        
        // å…³é—­å®‰æ…°å¼¹çª—
        closeComfortBtn.addEventListener('click', function() {
            comfortModal.style.display = 'none';
        });
        
        // åŠ è½½æŒ‡å®šæ—¥æœŸçš„è®°å½•
        function loadRecordByDate(date) {
            const record = moodHistory.find(record => record.date === date);
            
            // é‡ç½®é€‰æ‹©
            moodOptions.forEach(opt => opt.classList.remove('selected'));
            selectedMood = null;
            
            if (record) {
                // æ‰¾åˆ°è®°å½•ï¼ŒåŠ è½½åˆ°è¡¨å•
                moodOptions.forEach(opt => {
                    if (opt.getAttribute('data-mood') === record.mood) {
                        opt.classList.add('selected');
                        selectedMood = record.mood;
                    }
                });
                
                document.getElementById('note').value = record.note || '';
                
                // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                saveBtn.innerHTML = '<i class="fas fa-save"></i> æ›´æ–°å¿ƒæƒ…è®°å½•';
                isEditing = true;
                editingDate = date;
            } else {
                // æ²¡æœ‰è®°å½•ï¼Œæ¸…ç©ºè¡¨å•
                document.getElementById('note').value = '';
                saveBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜å¿ƒæƒ…è®°å½•';
                isEditing = false;
                editingDate = null;
            }
        }
        
        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            historyList.innerHTML = '';
            
            if (moodHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <i class="far fa-calendar-check fa-3x" style="margin-bottom: 15px; color: #cbd5e0;"></i>
                        <p>è¿˜æ²¡æœ‰ä»»ä½•å¿ƒæƒ…è®°å½•</p>
                        <p style="margin-top: 5px; font-size: 0.9rem;">é€‰æ‹©ä¸Šæ–¹çš„å¿ƒæƒ…å¼€å§‹è®°å½•å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            moodHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            moodHistory.forEach(record => {
                const moodIcon = getMoodIcon(record.mood);
                const moodColor = getMoodColorClass(record.mood);
                
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-date">${formatDisplayDate(record.date)}</div>
                    <div class="history-mood ${moodColor}">${moodIcon}</div>
                    <div class="history-note">${record.note || 'æ— å¤‡æ³¨'}</div>
                    <div class="history-actions">
                        <button class="history-edit-btn" data-date="${record.date}" title="ç¼–è¾‘æ­¤è®°å½•">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="history-delete-btn" data-date="${record.date}" title="åˆ é™¤æ­¤è®°å½•">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
            
            // ä¸ºç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶
            document.querySelectorAll('.history-edit-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const date = this.getAttribute('data-date');
                    datePicker.value = date;
                    loadRecordByDate(date);
                    
                    // æ»šåŠ¨åˆ°è¡¨å•åŒºåŸŸ
                    document.querySelector('.mood-selector').scrollIntoView({ behavior: 'smooth' });
                });
            });
            
            document.querySelectorAll('.history-delete-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const date = this.getAttribute('data-date');
                    deleteRecord(date);
                });
            });
            
            // ä¸ºå†å²è®°å½•é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆåŠ è½½è®°å½•ï¼‰
            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', function() {
                    const dateElement = this.querySelector('.history-date');
                    // ä»æ˜¾ç¤ºæ–‡æœ¬ä¸­æå–æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰
                    const dateText = dateElement.textContent;
                    const dateMatch = dateText.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
                    
                    if (dateMatch) {
                        const date = `${dateMatch[1]}-${dateMatch[2].padStart(2, '0')}-${dateMatch[3].padStart(2, '0')}`;
                        datePicker.value = date;
                        loadRecordByDate(date);
                        
                        // æ»šåŠ¨åˆ°è¡¨å•åŒºåŸŸ
                        document.querySelector('.mood-selector').scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });
        }
        
        // åˆ é™¤è®°å½•
        function deleteRecord(date) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ ${formatDisplayDate(date)} çš„å¿ƒæƒ…è®°å½•å—ï¼Ÿ`)) {
                moodHistory = moodHistory.filter(record => record.date !== date);
                localStorage.setItem('moodHistory', JSON.stringify(moodHistory));
                loadHistory();
                updateStats();
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ­£åœ¨ç¼–è¾‘çš„è®°å½•ï¼Œé‡ç½®è¡¨å•
                if (editingDate === date) {
                    resetForm();
                }
                
                alert('è®°å½•å·²åˆ é™¤ï¼');
            }
        }
        
        // é‡ç½®è¡¨å•
        function resetForm() {
            const today = getTodayDate();
            datePicker.value = today;
            moodOptions.forEach(opt => opt.classList.remove('selected'));
            selectedMood = null;
            document.getElementById('note').value = '';
            saveBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜å¿ƒæƒ…è®°å½•';
            isEditing = false;
            editingDate = null;
        }
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            totalDaysEl.textContent = moodHistory.length;
            
            // è®¡ç®—ç§¯æå’Œæ¶ˆæå¿ƒæƒ…å¤©æ•°
            const positiveMoods = ['å¼€å¿ƒ', 'å¹³é™'];
            const negativeMoods = ['éš¾è¿‡', 'çƒ¦èº'];
            
            const positiveDays = moodHistory.filter(record => 
                positiveMoods.includes(record.mood)
            ).length;
            
            const negativeDays = moodHistory.filter(record => 
                negativeMoods.includes(record.mood)
            ).length;
            
            positiveDaysEl.textContent = positiveDays;
            negativeDaysEl.textContent = negativeDays;
            
            // è®¡ç®—æœ€é•¿è¿ç»­è®°å½•å¤©æ•°
            let maxStreak = 0;
            let currentStreak = 0;
            let prevDate = null;
            
            // æŒ‰æ—¥æœŸæ’åºï¼ˆä»æ—©åˆ°æ™šï¼‰
            const sortedByDate = [...moodHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            sortedByDate.forEach(record => {
                const recordDate = new Date(record.date);
                
                if (prevDate === null) {
                    currentStreak = 1;
                } else {
                    const diffTime = recordDate - prevDate;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) {
                        currentStreak++;
                    } else if (diffDays > 1) {
                        currentStreak = 1;
                    }
                }
                
                maxStreak = Math.max(maxStreak, currentStreak);
                prevDate = recordDate;
            });
            
            currentStreakEl.textContent = maxStreak;
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå®‰æ…°å¼¹çª—
        function checkForComfortMessage() {
            const negativeMoods = ['éš¾è¿‡', 'çƒ¦èº'];
            
            // è·å–æœ€è¿‘3å¤©çš„è®°å½•ï¼ˆæŒ‰æ—¥æœŸæ’åºï¼‰
            const sortedByDate = [...moodHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentRecords = sortedByDate.slice(0, 3);
            
            // æ£€æŸ¥æœ€è¿‘3å¤©æ˜¯å¦éƒ½æ˜¯æ¶ˆæå¿ƒæƒ…
            if (recentRecords.length >= 3) {
                const allNegative = recentRecords.every(record => 
                    negativeMoods.includes(record.mood)
                );
                
                if (allNegative) {
                    // éšæœºé€‰æ‹©ä¸€æ¡å®‰æ…°è¯­å¥
                    const randomMessage = comfortMessages[Math.floor(Math.random() * comfortMessages.length)];
                    comfortMessage.textContent = randomMessage;
                    
                    // æ˜¾ç¤ºå®‰æ…°å¼¹çª—
                    setTimeout(() => {
                        comfortModal.style.display = 'flex';
                    }, 1000);
                }
            }
        }
        
        // è¾…åŠ©å‡½æ•°
        function getTodayDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function formatDisplayDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' };
            return date.toLocaleDateString('zh-CN', options);
        }
        
        function getMoodIcon(mood) {
            switch(mood) {
                case 'å¼€å¿ƒ': return 'ğŸ˜Š';
                case 'å¹³é™': return 'ğŸ˜Œ';
                case 'éš¾è¿‡': return 'ğŸ˜”';
                case 'çƒ¦èº': return 'ğŸ˜¤';
                default: return 'ğŸ˜';
            }
        }
        
        function getMoodColorClass(mood) {
            switch(mood) {
                case 'å¼€å¿ƒ': return 'happy';
                case 'å¹³é™': return 'calm';
                case 'éš¾è¿‡': return 'sad';
                case 'çƒ¦èº': return 'anxious';
                default: return '';
            }
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
        window.addEventListener('click', function(event) {
            if (event.target === moodModal) {
                moodModal.style.display = 'none';
            }
            if (event.target === comfortModal) {
                comfortModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>